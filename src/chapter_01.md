# Clickhouse 简介

## 简介

ClickHouse 是俄罗斯的 Yandex 于 2016 年开源的一个用于联机分析(OLAP:Online Analytical Processing)的列式数据库管理系统(DBMS:Database Management System)，简称 CK , 主要用于在线分析处理查询（OLAP），能够使用 SQL 查询实时生成分析数据报告。

**ClickHouse 是一个完全的列式数据库管理系统**，允许在运行时创建表和数据库，加载数据和运行查询，而无需重新配置和重新启动服务器，支持线性扩展，简单方便，高可靠性，容错。它在大数据领域没有走 Hadoop 生态，而是采用 Local attached storage 作为存储，这样整个 IO 可能就没有 Hadoop 那一套的局限。它的系统在生产环境中可以应用到比较大的规模，因为它的线性扩展能力和可靠性保障能够原生支持 shard + replication 这种解决方案。它还提供了一些 SQL 直接接口，有比较丰富的原生 client。**另外就是它比较快**。

选择 ClickHouse 的首要原因是它比较快，但其实它的技术没有什么新的地方，为什么会快？主要有四个方面的因素：

1. 它的数据剪枝能力比较强，分区剪枝在执行层，而存储格式用局部数据表示，就可以更细粒度地做一些数据的剪枝。它的引擎在实际使用中应用了一种现在比较流行的 LSM 方式。
2. 它对整个资源的垂直整合能力做得比较好，并发 MPP+ SMP 这种执行方式可以很充分地利用机器的集成资源。它的实现又做了很多性能相关的优化，它的一个简单的汇聚操作有很多不同的版本，会根据不同 Key 的组合方式有不同的实现。对于高级的计算指令，数据解压时，它也有少量使用。
3. ClickHouse  是一套完全由 C++ 模板 Code 写出来的实现，代码还是比较优雅的。
4. ClickHouse 是一个完全的列式数据库

## OLAP 简介

联机分析处理 OLAP 是一种软件技术，它使分析人员能够迅速、一致、交互地从各个方面观察信息，以达到深入理解数据的目的。它具有 FASMI(Fast Analysis of Shared Multidimensional Information)，即共享多维信息的快速分析的特征。其中 F 是快速性(Fast)，指系统能在数秒内对用户的多数分析要求做出反应；A 是可分析性(Analysis)，指用户无需编程就可以定义新的专门计算，将其作为分析的一部 分，并以用户所希望的方式给出报告；M 是多维性(Multi—dimensional)，指提供对数据分析的多维视图和分析；是信息性(Information)，指能及时获得信息，并且管理大容量信息!

1. OLAP 展现在用户面前的是一幅幅多维视图。维（Dimension）：是人们观察数据的特定角度，是考虑问题时的一类属性，属性集合构成一个维（时间维、地理维等）。
2. 维的层次（Level）：人们观察数据的某个特定角度（即某个维）还可以存在细节程度不同的各个描述方面（时间维：日期、月份、季度、年）。
3. 维的成员（Member）：维的一个取值，是数据项在某维中位置的描述。（“某年某月某日”是在时间维上位置的描述）。
4. 度量（Measure）：多维数组的取值。（2000 年 1 月，上海，笔记本电脑，0000）。
5. OLAP 的基本多维分析操作有钻取（Drill-up 和 Drill-down）、切片（Slice）和切块（Dice）、以及旋转（Pivot）等。
6. 钻取：是改变维的层次，变换分析的粒度。它包括向下钻取（Drill-down）和向上钻取（Drill-up）/上卷(Roll-up)。Drill-up 是在某一维上将低层次的细节数据概括到高层次的汇总数据，或者减少维数；而 Drill-down 则相反，它从汇总数据深入到细节数据进行观察或增加新维。
7. 切片和切块：是在一部分维上选定值后，关心度量数据在剩余维上的分布。如果剩余的维只有两个，则是切片；如果有三个或以上，则是切块。
8. 旋转：是变换维的方向，即在表格中重新安排维的放置（例如行列互换）。

## 特征

### 真正的列式数据库管理系统  

在一个真正的列式数据库管理系统中，除了数据本身外不应该存在其他额外的数据。这意味着为了避免在值旁边存储它们的长度«number»，你必须支持固定长度数值类型。

### 数据压缩

### 数据的磁盘存储

许多的列式数据库(如 SAP HANA, Google PowerDrill)只能在内存中工作，这种方式会造成比实际更多的设备预算。ClickHouse 被设计用于工作在传统磁盘上的系统，它提供每 GB 更低的存储成本，但如果有可以使用 SSD 和内存，它也会合理的利用这些资源。

### 多核心并行处理

### 多服务器分布式处理

上面提到的列式数据库管理系统中，几乎没有一个支持分布式的查询处理。
在 ClickHouse 中，数据可以保存在不同的 shard 上，每一个 shard 都由一组用于容错的 replica 组成，查询可以并行地在所有 shard 上进行处理。这些对用户来说是透明的

### 支持 SQL

ClickHouse 支持基于 SQL 的声明式查询语言，该语言大部分情况下是与 SQL 标准兼容的。
支持的查询包括 GROUP BY，ORDER BY，IN，JOIN 以及非相关子查询。
不支持窗口函数和相关子查询。

### 向量引擎

为了高效的使用 CPU，数据不仅仅按列存储，同时还按向量(列的一部分)进行处理，这样可以更加高效地使用 CPU。

### 实时的数据更新

ClickHouse 支持在表中定义主键。为了使查询能够快速在主键中进行范围查找，数据总是以增量的方式有序的存储在 MergeTree 中。因此，数据可以持续不断地高效的写入到表中，并且写入的过程中不会存在任何加锁的行为。

### 适合在线查询

在线查询意味着在没有对数据做任何预处理的情况下以极低的延迟处理查询并将结果加载到用户的页面中。

### 支持近似计算

ClickHouse 提供各种各样在允许牺牲数据精度的情况下对查询进行加速的方法：

1. 用于近似计算的各类聚合函数，如：distinct values, medians, quantiles
2. 基于数据的部分样本进行近似查询。这时，仅会从磁盘检索少部分比例的数据。
3. 不使用全部的聚合条件，通过随机选择有限个数据聚合条件进行聚合。这在数据聚合条件满足某些分布条件下，在提供相当准确的聚合结果的同时降低了计算资源的使用。

### 支持数据复制和数据完整性

ClickHouse 使用异步的多主复制技术。当数据被写入任何一个可用副本后，系统会在后台将数据分发给其他副本，以保证系统在不同副本上保持相同的数据。在大多数情况下 ClickHouse 能在故障后自动恢复，在一些少数的复杂情况下需要手动恢复。

## 性能

1. 单个查询吞吐量：如果数据被放置在 page cache 中，则一个不太复杂的查询在单个服务器上大约能够以 2-10GB／s（未压缩）的速度进行处理（对于简单的查询，速度可以达到 30GB／s）。如果数据没有在 page cache 中的话，那么速度将取决于你的磁盘系统和数据的压缩率。

2. 处理短查询的延时时间：数据被 page cache 缓存的情况下，它的延迟应该小于 50 毫秒(最佳情况下应该小于 10 毫秒)。 否则，延迟取决于数据的查找次数。延迟可以通过以下公式计算得知： `查找时间（10 ms）* 查询的列的数量 * 查询的数据块的数量`。

3. 处理大量短查询：ClickHouse 可以在单个服务器上每秒处理数百个查询（在最佳的情况下最多可以处理数千个）。但是由于这不适用于分析型场景。建议每秒最多查询 100 次。

4. 数据写入性能：建议每次写入不少于 1000 行的批量写入，或每秒不超过一个写入请求。当使用 tab-separated 格式将一份数据写入到 MergeTree 表中时，写入速度大约为 50 到 200MB/s。如果您写入的数据每行为 1Kb，那么写入的速度为 50，000 到 200，000 行每秒。如果您的行更小，那么写入速度将更高。为了提高写入性能，您可以使用多个 INSERT 进行并行写入，这将带来线性的性能提升。

count: 千万级别，500 毫秒，1 亿 800 毫秒  2 亿 900 毫秒 3 亿 1.1 秒
group: 百万级别 200 毫米，千万 1 秒，1 亿 10 秒，2 亿 20 秒，3 亿 30 秒
join：千万-10 万 600 毫秒， 千万 -百万：10 秒，千万-千万 150 秒

## 优缺点

### 优点

1. 为了高效的使用 CPU，数据不仅仅按列存储，同时还按向量进行处理；

2. 数据压缩空间大，减少 IO；处理单查询高吞吐量每台服务器每秒最多数十亿行；

3. 索引非 B 树结构，不需要满足最左原则；只要过滤条件在索引列中包含即可；即使在使用的数据不在索引中，由于各种并行处理机制 ClickHouse 全表扫描的速度也很快；

4. 写入速度非常快，50-200M/s，对于大量的数据更新非常适用。

### 缺点

1. 不支持事务，不支持真正的删除/更新；
2. 不支持高并发，官方建议 qps 为 100，可以通过修改配置文件增加连接数，但是在服务器足够好的情况下；
3. 不支持真正的删除/更新支持 不支持事务（期待后续版本支持）
4. 不支持二级索引
5. 有限的 SQL 支持，join 实现与众不同
6. 不支持窗口功能
7. 元数据管理需要人工干预维护
8. SQL 满足日常使用 80%以上的语法，join 写法比较特殊；最新版已支持类似 SQL 的 join，但性能不好；
9. 尽量做 1000 条以上批量的写入，避免逐行 insert 或小批量的 insert，update，delete 操作，因为 ClickHouse 底层会不断的做异步的数据合并，会影响查询性能，这个在做实时数据写入的时候要尽量避开；
10. ClickHouse 快是因为采用了并行处理机制，即使一个查询，也会用服务器一半的 CPU 去执行，所以 ClickHouse 不能支持高并发的使用场景，默认单查询使用 CPU 核数为服务器核数的一半，安装时会自动识别服务器核数，可以通过配置文件修改该参数。

## 应用场景

1. 绝大多数请求都是用于读访问的
2. 数据需要以大批次（大于 1000 行）进行更新，而不是单行更新；或者根本没有更新操作
3. 数据只是添加到数据库，没有必要修改
4. 读取数据时，会从数据库中提取出大量的行，但只用到一小部分列
5. 表很“宽”，即表中包含大量的列
6. 查询频率相对较低（通常每台服务器每秒查询数百次或更少）
7. 对于简单查询，允许大约 50 毫秒的延迟
8. 列的值是比较小的数值和短字符串（例如，每个 URL 只有 60 个字节）
9. 在处理单个查询时需要高吞吐量（每台服务器每秒高达数十亿行）
10. 不需要事务
11. 数据一致性要求较低
12. 每次查询中只会查询一个大表。除了一个大表，其余都是小表
13. 查询结果显著小于数据源。即数据有过滤或聚合。返回结果不超过单个服务器内存大小

核心应用：**快速的即时查询,数据展示!**
